name: 🛠️ Reusable / Release / Deploy

on:
  workflow_call:
    inputs:
      run-id:
        type: string
        description: Deploy artifact from run ID
        required: false
      environment:
        type: string
        description: Environment deploy to
        required: true
      artifact:
        type: string
        description: Artifact name
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Download artifact from current run
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artifact }}
          path: artifact
        if: ${{ !inputs.run-id }}

      - name: Download artifact from previous run
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artifact }}
          path: artifact
          run-id: ${{ inputs.run-id }}
          github-token: ${{ github.token }}
        if: ${{ !!inputs.run-id }}

      - name: Setup SSH
        env:
          DEPLOY_PRIVATE_KEY: ${{ secrets.DEPLOY_PRIVATE_KEY }}
          DEPLOY_KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
        run: |
          install -m 600 -D /dev/null ~/.ssh/id_rsa
          echo "$DEPLOY_PRIVATE_KEY" > ~/.ssh/id_rsa
          echo "$DEPLOY_KNOWN_HOSTS" > ~/.ssh/known_hosts
        if: ${{ secrets.DEPLOY_PRIVATE_KEY && secrets.DEPLOY_KNOWN_HOSTS }}

      - name: Deploy artifact
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_REMOTE_PATH: ${{ secrets.DEPLOY_REMOTE_PATH }}
          DEPLOY_REMOTE_PUBLIC_PATH: ${{ secrets.DEPLOY_REMOTE_PUBLIC_PATH }}
        run: make deploy
        if: ${{ secrets.DEPLOY_USER && secrets.DEPLOY_HOST && secrets.DEPLOY_REMOTE_PUBLIC_PATH }}

      - name: Deployment summary
        env:
          ARTIFACT: ${{ inputs.artifact }}
          RUN_ID: ${{ inputs.run-id || github.run_id }}
          ENVIRONMENT: ${{ inputs.environment }}
        run: |
          echo "🚀 Deployed artifact \`$ARTIFACT\` from run \`$RUN_ID\` to environment \`$ENVIRONMENT\`." >> $GITHUB_STEP_SUMMARY
